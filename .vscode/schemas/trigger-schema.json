{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Trigger Configuration",
  "description": "Configuration schema for job triggers - defines when and how jobs should be executed",
  "type": "object",
  "required": [
    "trigger"
  ],
  "properties": {
    "trigger": {
      "type": "object",
      "required": [
        "name",
        "type",
        "job"
      ],
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique name for this trigger",
          "pattern": "^[a-z0-9_]+$"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the trigger"
        },
        "type": {
          "type": "string",
          "enum": [
            "cron",
            "interval",
            "manual",
            "event",
            "webhook"
          ],
          "description": "Type of trigger"
        },
        "enabled": {
          "type": "boolean",
          "description": "Whether this trigger is enabled",
          "default": true
        },
        "environment": {
          "type": "string",
          "enum": [
            "dev",
            "stage",
            "prod"
          ],
          "description": "Environment where this trigger should run (if omitted, runs in all environments)"
        },
        "job": {
          "type": "string",
          "description": "Job configuration file to execute (in jobs/ directory)",
          "pattern": "^(jobs/)?[a-z0-9_]+\\.yaml$"
        },
        "parameters": {
          "type": "object",
          "description": "Parameters to pass to the job execution",
          "additionalProperties": true
        },
        "tags": {
          "type": "array",
          "description": "Tags for trigger organization and filtering",
          "items": {
            "type": "string"
          }
        }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "trigger": {
            "properties": {
              "type": {
                "const": "cron"
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "trigger": {
            "required": [
              "schedule"
            ],
            "properties": {
              "schedule": {
                "type": "object",
                "required": [
                  "cron"
                ],
                "properties": {
                  "cron": {
                    "type": "string",
                    "description": "Cron expression (e.g., '0 * * * *' for every hour)",
                    "pattern": "^(@(annually|yearly|monthly|weekly|daily|hourly|reboot))|(@every (\\d+(ns|us|Âµs|ms|s|m|h))+)|(((\\S+\\s+){4}\\S+)|((\\S+\\s+){5}\\S+))$"
                  },
                  "timezone": {
                    "type": "string",
                    "description": "Timezone for cron schedule (IANA timezone name)",
                    "default": "UTC",
                    "examples": [
                      "UTC",
                      "America/New_York",
                      "Europe/London",
                      "Asia/Tokyo"
                    ]
                  },
                  "catchup": {
                    "type": "boolean",
                    "description": "Whether to run missed schedules if service was down",
                    "default": false
                  },
                  "jitter": {
                    "type": "integer",
                    "description": "Random jitter in seconds to add to scheduled time (helps prevent thundering herd)",
                    "minimum": 0,
                    "maximum": 3600
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "trigger": {
            "properties": {
              "type": {
                "const": "interval"
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "trigger": {
            "required": [
              "schedule"
            ],
            "properties": {
              "schedule": {
                "type": "object",
                "required": [
                  "interval"
                ],
                "properties": {
                  "interval": {
                    "type": "object",
                    "description": "Interval configuration",
                    "required": [
                      "value",
                      "unit"
                    ],
                    "properties": {
                      "value": {
                        "type": "integer",
                        "description": "Interval value",
                        "minimum": 1
                      },
                      "unit": {
                        "type": "string",
                        "enum": [
                          "seconds",
                          "minutes",
                          "hours",
                          "days"
                        ],
                        "description": "Interval unit"
                      }
                    }
                  },
                  "start_time": {
                    "type": "string",
                    "description": "ISO 8601 timestamp when interval should start",
                    "format": "date-time"
                  },
                  "end_time": {
                    "type": "string",
                    "description": "ISO 8601 timestamp when interval should end",
                    "format": "date-time"
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "trigger": {
            "properties": {
              "type": {
                "const": "event"
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "trigger": {
            "required": [
              "event"
            ],
            "properties": {
              "event": {
                "type": "object",
                "required": [
                  "source",
                  "event_type"
                ],
                "properties": {
                  "source": {
                    "type": "string",
                    "description": "Event source (e.g., 's3', 'kafka', 'sns')",
                    "examples": [
                      "s3",
                      "kafka",
                      "sns",
                      "sqs",
                      "pubsub"
                    ]
                  },
                  "event_type": {
                    "type": "string",
                    "description": "Type of event to listen for",
                    "examples": [
                      "object_created",
                      "object_deleted",
                      "message_received"
                    ]
                  },
                  "filter": {
                    "type": "object",
                    "description": "Event filtering criteria",
                    "properties": {
                      "prefix": {
                        "type": "string",
                        "description": "Filter events by resource prefix"
                      },
                      "suffix": {
                        "type": "string",
                        "description": "Filter events by resource suffix"
                      },
                      "pattern": {
                        "type": "string",
                        "description": "Regex pattern to match event properties"
                      }
                    }
                  },
                  "config": {
                    "type": "object",
                    "description": "Event source-specific configuration",
                    "additionalProperties": true
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "trigger": {
            "properties": {
              "type": {
                "const": "webhook"
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "trigger": {
            "required": [
              "webhook"
            ],
            "properties": {
              "webhook": {
                "type": "object",
                "required": [
                  "path"
                ],
                "properties": {
                  "path": {
                    "type": "string",
                    "description": "Webhook URL path (e.g., '/webhooks/my-trigger')",
                    "pattern": "^/[a-z0-9/_-]+$"
                  },
                  "methods": {
                    "type": "array",
                    "description": "Allowed HTTP methods",
                    "items": {
                      "type": "string",
                      "enum": [
                        "GET",
                        "POST",
                        "PUT",
                        "PATCH"
                      ]
                    },
                    "default": [
                      "POST"
                    ],
                    "minItems": 1
                  },
                  "authentication": {
                    "type": "object",
                    "description": "Webhook authentication configuration",
                    "required": [
                      "type"
                    ],
                    "properties": {
                      "type": {
                        "type": "string",
                        "enum": [
                          "none",
                          "token",
                          "hmac",
                          "oauth2"
                        ],
                        "description": "Authentication type"
                      },
                      "secret_key": {
                        "type": "string",
                        "description": "Secret key reference for authentication",
                        "pattern": "_secret_key$"
                      },
                      "header_name": {
                        "type": "string",
                        "description": "Header name containing authentication token",
                        "default": "Authorization"
                      }
                    }
                  },
                  "payload_mapping": {
                    "type": "object",
                    "description": "Map webhook payload fields to job parameters",
                    "additionalProperties": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  ]
}
