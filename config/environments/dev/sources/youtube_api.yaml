# YouTube Analytics API Source Configuration (Development)
source:
  name: youtube_analytics
  type: rest_api
  description: "YouTube Analytics API for channel statistics and video data"
  environment: dev

  connection:
    base_url: "https://www.googleapis.com/youtube/v3"
    auth:
      type: oauth2
      # This key maps to GitHub Secret: YOUTUBE_API_KEY_DEV
      credentials_secret_key: "YOUTUBE_API_KEY_DEV"
    timeout: 30
    retry:
      max_attempts: 3
      backoff_factor: 2
      backoff_max: 60

  resources:
    - name: channel_stats
      description: "Channel statistics including subscribers, views, and video count"
      endpoint: "/channels"
      method: GET
      params:
        part: "statistics,snippet,contentDetails"
        # Channel ID will be provided via config or CLI
        id: "{channel_id}"

      incremental:
        enabled: true
        strategy: "append"
        cursor_field: "snippet.publishedAt"
        initial_value: "2024-01-01T00:00:00Z"

      primary_key: ["id"]

      write_disposition: "merge"

      schema:
        columns:
          - name: id
            data_type: string
            nullable: false
            description: "Channel ID"
          - name: title
            data_type: string
            nullable: false
            description: "Channel title"
          - name: description
            data_type: string
            nullable: true
            description: "Channel description"
          - name: subscriber_count
            data_type: integer
            nullable: true
            description: "Total number of subscribers"
          - name: view_count
            data_type: integer
            nullable: true
            description: "Total number of views"
          - name: video_count
            data_type: integer
            nullable: true
            description: "Total number of videos"
          - name: published_at
            data_type: timestamp
            nullable: false
            description: "Channel creation date"
          - name: _extracted_at
            data_type: timestamp
            nullable: false
            description: "Timestamp when data was extracted"

      data_quality:
        checks:
          - type: not_null
            columns: [id, title, published_at]
          - type: positive
            columns: [subscriber_count, view_count, video_count]
          - type: unique
            columns: [id]

      pii_fields: []

      aliases:
        subscriber_count: total_subscribers
        view_count: total_views
        video_count: total_videos

    - name: videos
      description: "Video details and statistics"
      endpoint: "/videos"
      method: GET
      params:
        part: "snippet,statistics,contentDetails"
        # Video IDs will be fetched from previous resource or provided
        id: "{video_ids}"
        maxResults: 50

      incremental:
        enabled: true
        strategy: "merge"
        cursor_field: "snippet.publishedAt"
        initial_value: "2024-01-01T00:00:00Z"

      primary_key: ["id"]

      write_disposition: "merge"

      schema:
        columns:
          - name: id
            data_type: string
            nullable: false
          - name: channel_id
            data_type: string
            nullable: false
          - name: title
            data_type: string
            nullable: false
          - name: description
            data_type: string
            nullable: true
          - name: published_at
            data_type: timestamp
            nullable: false
          - name: view_count
            data_type: integer
            nullable: true
          - name: like_count
            data_type: integer
            nullable: true
          - name: comment_count
            data_type: integer
            nullable: true
          - name: duration
            data_type: string
            nullable: true
          - name: _extracted_at
            data_type: timestamp
            nullable: false

      data_quality:
        checks:
          - type: not_null
            columns: [id, channel_id, title, published_at]
          - type: unique
            columns: [id]

      pii_fields: []
